<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>TitanMoisture (Moisture Notes v0.2)</title>

  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root{
      --navy:#0B2A3A;
      --navy2:#0E3348;

      --bg:#F5F7FB;
      --panel:#FFFFFF;
      --border:#E5EAF1;
      --text:#0F172A;
      --sub:#64748B;

      /* TitanRoof palette reused */
      --c-ts:#DC2626;   /* red */
      --c-apt:#111827;  /* gray/black */
      --c-ds:#2563EB;   /* blue */
      --c-wind:#16A34A; /* green */
      --c-obs:#9333EA;  /* purple */

      /* Moisture accents (still on-brand) */
      --c-aoi: var(--c-obs);      /* Areas of Interest = purple */
      --c-read: var(--c-ds);      /* Readings = blue */
      --c-note: var(--c-apt);     /* General note = charcoal */
      --c-line: rgba(37,99,235,0.7);
      --c-drain: rgba(100,116,139,0.7);

      --teal:#0BA7A5;

      --shadow: 0 14px 28px rgba(2,6,23,0.10);
      --shadowSoft: 0 10px 20px rgba(2,6,23,0.07);
      --ring: 0 0 0 3px rgba(11,167,165,0.18);

      --glass: rgba(255,255,255,0.72);
      --glass2: rgba(255,255,255,0.86);
      --glassBorder: rgba(226,232,240,0.70);
    }

    *{ box-sizing:border-box; }
    html, body{
      margin:0;
      height:100%;
      overflow:hidden;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      -webkit-text-size-adjust: 100%;
    }

    .app{
      display:grid;
      grid-template-columns: 1fr var(--panel-width, minmax(320px, 420px));
      height:100vh;
      min-height:100vh;
    }
    .app.panelCollapsed{
      --panel-width: 32px;
    }

    /* ========= CANVAS ZONE ========= */
    .canvasZone{
      position:relative;
      overflow:hidden;
      user-select:none;
      -webkit-user-select:none;
      background:
        radial-gradient(1200px 700px at 20% 15%, rgba(11,167,165,0.10), transparent 55%),
        radial-gradient(900px 600px at 80% 70%, rgba(37,99,235,0.10), transparent 55%),
        #E9EEF5;
    }
    .viewport{
      position:absolute;
      inset:0;
      overflow:hidden;
      touch-action:none;
      cursor: default;
    }
    .stage{
      position:absolute;
      left:50%;
      top:50%;
      transform-origin: 0 0;
    }
    .sheet{
      width: 1024px;
      height: 720px;
      background:#fff;
      border-radius:18px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(15,23,42,0.06);
      overflow:hidden;
      position:relative;
    }
    .sheetBg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:contain;
      pointer-events:none;
      opacity: 0.92;
    }
    .sheetGrid{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity: 0.6;
    }
    .sheetGrid line{ stroke: rgba(148,163,184,0.32); stroke-width:1; }
    .sheetGrid .major{ stroke: rgba(148,163,184,0.55); }

    /* ========= TOOLBAR ========= */
    .toolbar{
      position: fixed;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      padding:10px 14px;
      border-radius: 18px;
      background: var(--glass2);
      backdrop-filter: blur(12px);
      border: 1px solid var(--glassBorder);
      box-shadow: var(--shadowSoft);
      z-index: 80;
      user-select:none;
      -webkit-user-select:none;
      touch-action:none;
      cursor: grab;
    }
    .toolbar.locked{ cursor: default; }
    .toolbar.dragging{ cursor: grabbing; }
    .tbCenter{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
    }
    .tbTitle{
      font-size:12px;
      font-weight:1200;
      text-transform:uppercase;
      color: var(--sub);
      letter-spacing:0.4px;
    }
    .tbTools{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:nowrap;
    }
    .tbDivider{
      width:1px;
      height:32px;
      background: rgba(148,163,184,0.4);
      border-radius: 999px;
    }

    .toolBtn{
      --toolColor: var(--c-aoi);
      display:flex;
      align-items:center;
      justify-content:center;
      height:44px;
      width:52px;
      min-width:52px;
      padding:0 10px;
      border-radius: 999px;
      border:2px solid var(--toolColor);
      background:#fff;
      cursor:pointer;
      font-family:inherit;
      appearance:none;
      transition: transform 0.10s ease, box-shadow 0.10s ease, border-color 0.10s ease, background 0.10s ease;
      white-space:nowrap;
      color: var(--toolColor);
    }
    .toolBtn .toolText{
      font-size:12px;
      font-weight:1200;
      letter-spacing:0.4px;
    }
    .toolBtn.expanded{
      width:auto;
      min-width:0;
      padding:0 16px;
    }
    .toolBtn:hover{
      transform: translateY(-1px);
      box-shadow: 0 8px 14px rgba(2,6,23,0.10);
    }
    .toolBtn.active{
      background: var(--toolColor);
      border-color: var(--toolColor);
      color:#fff;
      box-shadow: 0 10px 16px rgba(2,6,23,0.12);
    }
    .toolBtn.aoi{ --toolColor: var(--c-aoi); }
    .toolBtn.read{ --toolColor: var(--c-read); }
    .toolBtn.note{ --toolColor: var(--c-note); }

    .lockIcon{
      width:38px;
      height:38px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius: 12px;
      border:1px solid rgba(226,232,240,0.95);
      background:#fff;
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
    }
    .lockIcon:hover{ background: rgba(241,245,249,0.85); }
    .lockIcon svg{ width:18px; height:18px; }
    .lockIcon.locked svg{ color:#F59E0B; }
    .lockIcon.unlocked svg{ color: rgba(148,163,184,1); }

    /* ========= NAV TOOLS (BOTTOM RIGHT) ========= */
    .navTools{
      position:absolute;
      right:16px;
      bottom:16px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index: 70;
      user-select:none;
      -webkit-user-select:none;
    }
    .navCard{
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(226,232,240,0.85);
      border-radius: 16px;
      box-shadow: var(--shadowSoft);
      padding: 10px;
      width: 250px;
    }
    .navRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .zBtns{ display:flex; gap:8px; flex-wrap:wrap; }
    .zBtn{
      padding:10px 11px;
      border-radius:12px;
      border:1px solid rgba(226,232,240,0.95);
      background:#fff;
      cursor:pointer;
      font-size:12px;
      font-weight:1100;
      user-select:none;
    }
    .zBtn:hover{ background:#F8FAFC; }
    .zReadout{
      font-size:12px;
      font-weight:1100;
      color: var(--navy);
      padding: 10px 11px;
      border-radius:12px;
      border:1px solid rgba(226,232,240,0.95);
      background: #fff;
      min-width: 74px;
      text-align:center;
    }
    .hint{
      margin-top:8px;
      font-size:11px;
      color: var(--sub);
      line-height:1.35;
    }

    /* ========= PROPERTIES PANEL ========= */
    .panel{
      background: var(--panel);
      border-left: 1px solid var(--border);
      display:flex;
      flex-direction:column;
      box-shadow: -10px 0 26px rgba(2,6,23,0.05);
      position:relative;
      min-width: 0;
      height: 100vh;
      transition: width 0.2s ease, transform 0.2s ease;
      overflow: hidden;
    }
    .panel.collapsed{
      width: 32px;
      min-width: 32px;
    }
    .panelContent{
      display:flex;
      flex-direction:column;
      height: 100%;
    }
    .panel.collapsed .panelContent{
      opacity: 0;
      pointer-events: none;
    }

    .pHeader{
      padding:14px 16px 16px;
      background: linear-gradient(135deg, rgba(14,165,233,0.92), rgba(37,99,235,0.92));
      color:#fff;
      display:flex;
      flex-direction:column;
      align-items:stretch;
      gap:12px;
      min-width:0;
    }
    .hdrLine0{
      font-size:11px;
      font-weight:1100;
      letter-spacing:0.55px;
      text-transform:uppercase;
      opacity:0.9;
      margin-bottom:6px;
    }
    .hdrLine1{
      font-size:24px;
      font-weight:1200;
      letter-spacing:0.2px;
      line-height:1.15;
      white-space:normal;
      overflow-wrap:break-word;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .hdrLine2, .hdrLine3{
      margin-top:6px;
      font-size:12px;
      font-weight:1000;
      opacity:0.92;
      line-height:1.35;
      white-space:normal;
      overflow-wrap:break-word;
    }
    .hdrActions{
      display:flex;
      align-items:flex-start;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-start;
    }
    .hdrBtn{
      padding:8px 10px;
      min-width: 110px;
      height: 36px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.32);
      background: rgba(255,255,255,0.16);
      color:#fff;
      font-size:12px;
      font-weight:1200;
      cursor:pointer;
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .hdrBtn.danger{
      border-color: rgba(254,226,226,0.55);
      background: rgba(239,68,68,0.22);
    }
    .hdrBtn.iconOnly{
      min-width: 36px;
      width: 36px;
      padding: 8px;
    }
    .hdrIconInline{
      width: 28px;
      height: 28px;
      min-width: 28px;
      padding: 0;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,0.35);
      background: rgba(255,255,255,0.18);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .panelToggle{
      position:absolute;
      top: 18px;
      left: -16px;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border:1px solid rgba(226,232,240,0.95);
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: var(--shadowSoft);
      cursor:pointer;
      z-index: 10;
    }
    .hdrSaveMeta{
      font-size:11px;
      color: rgba(255,255,255,0.85);
      text-align:center;
      min-height: 12px;
    }
    .hdrSaveMeta.error{
      color: rgba(254,226,226,0.95);
    }
    .pScroll{
      flex:1;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:14px;
      min-width:0;
    }
    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      box-shadow: var(--shadowSoft);
      min-width:0;
    }
    .card.editCard{
      background: rgba(30,64,175,0.12);
      border-color: rgba(37,99,235,0.4);
    }
    .card.editCard .inp,
    .card.editCard select,
    .card.editCard textarea{
      background: rgba(255,255,255,0.85);
      border-color: rgba(37,99,235,0.35);
    }
    .lbl{
      display:block;
      font-size:11px;
      font-weight:1000;
      text-transform:uppercase;
      color: var(--sub);
      letter-spacing:0.45px;
      margin-bottom:8px;
    }
    .inp, select, textarea{
      width:100%;
      padding:12px 12px;
      font-size:14px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      outline:none;
      color:var(--text);
    }
    textarea{ min-height:84px; resize:vertical; }
    .inp:focus, select:focus, textarea:focus{
      border-color: var(--teal);
      box-shadow: var(--ring);
    }
    .row{ display:flex; gap:10px; align-items:center; min-width:0; }
    .row > *{ flex:1; min-width:0; }
    .btn{
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-size:13px;
      font-weight:1100;
      user-select:none;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 16px rgba(2,6,23,0.08); background:#F8FAFC; }
    .btnPrimary{
      border-color: rgba(11,167,165,0.35);
      color: var(--teal);
      background: rgba(11,167,165,0.06);
    }
    .btnDanger{
      border-color: rgba(220,38,38,0.35);
      color: #B91C1C;
      background: rgba(220,38,38,0.06);
    }
    .btnFull{ width:100%; }
    .tiny{ color: var(--sub); font-size:12px; line-height:1.35; }
    .hr{ height:1px; background: rgba(226,232,240,0.95); margin: 10px 0; }

    /* Items */
    .groupHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:12px;
      font-weight:1200;
      text-transform:uppercase;
      color: var(--sub);
      letter-spacing:0.45px;
      margin: 8px 0 10px 0;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(226,232,240,0.95);
      background:#F8FAFC;
      cursor:pointer;
    }
    .groupHeader .groupTitle{ display:flex; align-items:center; gap:8px; }
    .groupHeader .groupCount{
      font-size:11px;
      font-weight:1200;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(226,232,240,0.95);
      background:#fff;
      color:#0B1220;
      text-transform:none;
    }
    .groupHeader .groupChevron{
      width:20px;
      height:20px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      background:rgba(255,255,255,0.75);
    }
    .groupHeader.aoi{ border-color: rgba(147,51,234,0.3); background: rgba(147,51,234,0.08); color:#6B21A8; }
    .groupHeader.read{ border-color: rgba(37,99,235,0.3); background: rgba(37,99,235,0.08); color:#1E40AF; }
    .groupHeader.note{ border-color: rgba(17,24,39,0.2); background: rgba(17,24,39,0.06); color:#111827; }
    .groupHeader.line{ border-color: rgba(37,99,235,0.35); background: rgba(37,99,235,0.12); color:#1E40AF; }

    .itemRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      user-select:none;
      border-left-width:5px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease, border-color 0.08s ease;
    }
    .itemRow:hover{ transform: translateY(-1px); box-shadow: 0 10px 16px rgba(2,6,23,0.08); background:#F8FAFC; }
    .itemRow.selected{
      border-color: rgba(11,167,165,0.55);
      box-shadow: var(--ring);
      background:#F1F5F9;
    }
    .itemInfo{ min-width:0; flex:1; }
    .itemInfo b{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
      font-weight:1200;
      white-space:normal;
      overflow-wrap:anywhere;
      line-height:1.25;
      color:#0B1220;
    }
    .itemInfo span{
      display:block;
      font-size:12px;
      color: var(--sub);
      margin-top:4px;
      white-space:normal;
      overflow-wrap:anywhere;
      line-height:1.25;
    }

    .badge{
      font-size:11px;
      font-weight:1200;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.45);
      background: rgba(241,245,249,0.9);
      color:#0B1220;
      white-space:nowrap;
      flex:0 0 auto;
    }

    /* Markers */
    .marker{
      position:absolute;
      transform: translate(-50%,-50%);
      width: 34px;
      height: 34px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:1200;
      font-size:12px;
      border:2px solid rgba(255,255,255,0.92);
      box-shadow: 0 10px 18px rgba(2,6,23,0.22);
      user-select:none;
    }
    .marker.aoi{ background: var(--c-aoi); border-radius: 14px; }
    .marker.read{ background: var(--c-read); border-radius: 999px; }
    .marker.note{ background: var(--c-note); border-radius: 999px; }
    .marker.selected{
      outline: 3px solid rgba(11,167,165,0.45);
      outline-offset: 2px;
    }
    .areaLabel{
      position:absolute;
      transform: translate(-50%,-50%);
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(147,51,234,0.92);
      color:#fff;
      font-weight:1200;
      font-size:11px;
      border:2px solid rgba(255,255,255,0.92);
      box-shadow: 0 10px 18px rgba(2,6,23,0.18);
      user-select:none;
    }
    .areaLabel.selected{
      outline: 3px solid rgba(11,167,165,0.45);
      outline-offset: 2px;
    }
    .sheetOverlay{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .areaPoly{
      fill: rgba(147,51,234,0.18);
      stroke: rgba(147,51,234,0.9);
      stroke-width: 2;
    }
    .areaPoly.draft{
      fill: rgba(147,51,234,0.12);
      stroke-dasharray: 6 4;
    }
    .areaPoint{
      fill: #fff;
      stroke: rgba(147,51,234,0.9);
      stroke-width: 2;
    }
    .areaPolyClickable{
      pointer-events: all;
      cursor: pointer;
    }
    .lineStroke{
      stroke: var(--c-line);
      stroke-width: 4;
      stroke-linecap: round;
      stroke-dasharray: 0;
      pointer-events: stroke;
    }
    .lineStroke.drain{
      stroke: var(--c-drain);
    }
    .lineLabel{
      position:absolute;
      transform: translate(-50%,-50%);
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(37,99,235,0.9);
      color:#fff;
      font-weight:1200;
      font-size:10px;
      border:2px solid rgba(255,255,255,0.92);
      box-shadow: 0 8px 14px rgba(2,6,23,0.18);
      user-select:none;
      cursor: pointer;
    }
    .lineLabel.drain{ background: rgba(100,116,139,0.9); }
    .lineLabel.selected{
      outline: 3px solid rgba(11,167,165,0.45);
      outline-offset: 2px;
    }

    /* Responsive */
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr var(--panel-width, minmax(300px, 360px)); }
    }
    @media (max-width: 820px){
      .app{ grid-template-columns: 1fr; }
      .toolbar{
        max-width: calc(100% - 24px);
        left: 50% !important;
        top: 10px !important;
        transform: translateX(-50%);
        padding: 8px 10px;
      }
      .tbTools{
        max-width: 100%;
        overflow-x: auto;
        padding-bottom: 4px;
        scroll-snap-type: x mandatory;
      }
      .toolBtn{ scroll-snap-align: center; }
      .navTools{ right:12px; bottom:90px; }
      .navCard{ width: 210px; }

      .panel{
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        width: min(100%, 420px);
        transform: translateX(100%);
        transition: transform 0.2s ease;
        z-index: 90;
      }
      .panel.mobileOpen{ transform: translateX(0); }
      .panelOverlay{
        position: fixed;
        inset: 0;
        background: rgba(15,23,42,0.35);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
        z-index: 85;
      }
      .panelOverlay.show{
        opacity: 1;
        pointer-events: auto;
      }
      .mobileDock{
        position: fixed;
        left: 12px;
        right: 12px;
        bottom: 16px;
        display: flex;
        gap: 10px;
        z-index: 80;
      }
      .mobileDock .btn{ flex: 1 1 0; }
    }

    .ico{ width:18px; height:18px; color: currentColor; }

    .printArea{
      display:none;
    }
    @media print{
      body{ background:#fff; overflow: visible; }
      body *{ visibility: hidden; }
      .printArea, .printArea *{ visibility: visible; }
      .printArea{
        display:block;
        position:absolute;
        inset:0;
        padding: 0;
      }
      .printPage{
        page-break-after: always;
        padding: 24px 28px 30px;
      }
      .printHeader{
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        gap:20px;
        margin-bottom: 18px;
      }
      .printTitle{
        font-size:20px;
        font-weight:1200;
        color:#0B1220;
      }
      .printMeta{
        font-size:12px;
        color:#475569;
        line-height:1.4;
      }
      .printSheetWrap{
        border:1px solid rgba(148,163,184,0.6);
        border-radius:18px;
        padding: 12px;
        margin-bottom: 18px;
        page-break-inside: avoid;
      }
      .printSheet{
        width: 100%;
        aspect-ratio: 1024 / 720;
        position:relative;
        overflow: visible;
        border-radius:14px;
        border:1px solid rgba(148,163,184,0.4);
        background:#fff;
      }
      .printList{
        margin-top: 12px;
        font-size:12px;
      }
      .printGrid{
        display:grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap:10px;
      }
      .printList h4{
        margin: 0 0 8px 0;
        font-size:12px;
        text-transform:uppercase;
        letter-spacing:0.4px;
        color:#475569;
      }
      .printListItem{
        padding: 8px 10px;
        border:1px solid rgba(148,163,184,0.4);
        border-radius:10px;
        margin-bottom:8px;
        background:#F8FAFC;
        break-inside: avoid;
      }
      .printFoot{
        margin-top: 10px;
        font-size:11px;
        color:#64748B;
      }
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useRef, useEffect, useCallback } = React;

    const uid = () => Math.random().toString(36).slice(2, 10);
    const clamp = (v, min, max) => Math.min(Math.max(v, min), max);

    function readFileAsDataUrl(file){
      if(!file) return Promise.resolve(null);
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(reader.error);
        reader.readAsDataURL(file);
      });
    }
    async function fileToObj(file){
      if(!file) return null;
      const dataUrl = await readFileAsDataUrl(file);
      return { name: file.name, url: dataUrl, dataUrl };
    }
    function reviveFileObj(obj){
      if(!obj) return null;
      const dataUrl = obj.dataUrl || obj.url;
      if(!dataUrl) return null;
      return { name: obj.name || "image", url: dataUrl, dataUrl };
    }

    const Icon = ({name, className=""}) => {
      const common = { className: `ico ${className}`, viewBox:"0 0 24 24", fill:"none", stroke:"currentColor", strokeWidth:"2", strokeLinecap:"round", strokeLinejoin:"round" };
      if(name === "lock"){
        return (<svg {...common}><rect x="5" y="11" width="14" height="10" rx="2"/><path d="M8 11V8a4 4 0 0 1 8 0v3"/></svg>);
      }
      if(name === "unlock"){
        return (<svg {...common}><rect x="5" y="11" width="14" height="10" rx="2"/><path d="M8 11V8a4 4 0 0 1 7-2"/></svg>);
      }
      if(name === "chevDown"){
        return (<svg {...common}><path d="M6 9l6 6 6-6"/></svg>);
      }
      if(name === "chevUp"){
        return (<svg {...common}><path d="M6 15l6-6 6 6"/></svg>);
      }
      if(name === "pencil"){
        return (<svg {...common}><path d="M12 20h9"/><path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>);
      }
      if(name === "save"){
        return (<svg {...common}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></svg>);
      }
      if(name === "export"){
        return (<svg {...common}><path d="M12 5v10"/><path d="M8 9l4-4 4 4"/><path d="M20 21H4"/></svg>);
      }
      if(name === "trash"){
        return (<svg {...common}><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>);
      }
      if(name === "chevLeft"){
        return (<svg {...common}><path d="M15 18l-6-6 6-6"/></svg>);
      }
      if(name === "chevRight"){
        return (<svg {...common}><path d="M9 18l6-6-6-6"/></svg>);
      }
      return null;
    };

    const STORAGE_KEY = "titanmoisture.v0.2.state";

    const ROOMS_DEFAULT = ["Living", "Kitchen", "Primary Bed", "Bath 1", "Hall", "Attic", "Garage", "Other"];
    const ELEVATIONS = ["Ceiling", "Wall", "Floor", "Window", "Door", "Trim", "Cabinet", "Other"];
    const INTERIOR_CONDITIONS = [
      "Moisture staining (spot)",
      "Moisture staining (area/pattern)",
      "Peeled paint",
      "Bubbled/blistered paint",
      "Drywall softening",
      "Swollen wood fibers",
      "Baseboard separation",
      "Efflorescence",
      "Corrosion/oxidation",
      "Microbial-like growth",
      "Musty odor noted",
      "Other"
    ];
    const INSTRUMENTS = ["Pin meter", "Pinless meter", "IR camera", "Hygrometer", "Other/Unknown"];

    function App(){
      const viewportRef = useRef(null);
      const stageRef = useRef(null);
      const sheetRef = useRef(null);
      const toolbarRef = useRef(null);

      const [tool, setTool] = useState("aoi"); // aoi | area | read | line | note | pan
      const [selectedId, setSelectedId] = useState(null);

      const [toolbarPos, setToolbarPos] = useState({ x: 20, y: 80 });
      const [toolbarDragging, setToolbarDragging] = useState(false);
      const [toolbarLocked, setToolbarLocked] = useState(false);
      const toolbarDragRef = useRef(null);

      const [mobilePanelOpen, setMobilePanelOpen] = useState(false);
      const [lastSavedAt, setLastSavedAt] = useState(null);
      const [saveError, setSaveError] = useState(null);
      const [isMobile, setIsMobile] = useState(window.innerWidth <= 820);
      const [panelCollapsed, setPanelCollapsed] = useState(false);

      // Header / project meta
      const [hdrCollapsed, setHdrCollapsed] = useState(true);
      const [hdrEditOpen, setHdrEditOpen] = useState(false);

      const [projectName, setProjectName] = useState("Enter Name");
      const [inspectionDate, setInspectionDate] = useState("");
      const [propertyCity, setPropertyCity] = useState("Houston, Texas");
      const [eventContext, setEventContext] = useState("Moisture Intrusion Assessment");
      const [scopeNote, setScopeNote] = useState("Interior observations and moisture-related conditions.");
      const [residentNotes, setResidentNotes] = useState("");

      const defaultPage = useMemo(() => ({ id: uid(), name: "Page 1", bg: null }), []);
      const [pages, setPages] = useState([defaultPage]);
      const [activePageId, setActivePageId] = useState(defaultPage.id);

      // items
      const counts = useRef({ aoi:1, area:1, read:1, line:1, note:1 });
      const [items, setItems] = useState([]);
      const [draftPolygon, setDraftPolygon] = useState(null);
      const [draftLine, setDraftLine] = useState(null);
      const suppressClickRef = useRef(false);

      // view (pan/zoom + pinch)
      const [view, setView] = useState({ scale: 1.0, tx: 0, ty: 0 });
      const [drag, setDrag] = useState(null); // {mode:'pan'|'move', id, start:{x,y}, origin:{tx,ty} or originPos:{x,y}}

      useEffect(() => {
        if(!isMobile) setMobilePanelOpen(false);
        if(isMobile) setPanelCollapsed(false);
      }, [isMobile]);

      useEffect(() => {
        if(tool !== "area") setDraftPolygon(null);
        if(tool !== "line") setDraftLine(null);
        if(tool === "line"){
          setDraftLine(prev => (prev && prev.pageId !== activePageId ? null : prev));
        }
      }, [tool, activePageId]);

      const activeItem = items.find(i => i.id === selectedId) || null;
      const activePage = pages.find(p => p.id === activePageId) || pages[0];
      const activePageIndex = pages.findIndex(p => p.id === activePageId);
      const activeItems = useMemo(() => items.filter(i => i.pageId === activePage?.id), [items, activePage]);

      // ===== persistence =====
      const serializeItem = (it) => ({
        ...it,
        data: {
          ...it.data,
          photo: it.data.photo ? { name: it.data.photo.name, dataUrl: it.data.photo.dataUrl || it.data.photo.url } : null
        }
      });
      const serializePage = (page) => ({
        ...page,
        bg: page.bg ? { name: page.bg.name, dataUrl: page.bg.dataUrl || page.bg.url } : null
      });

      const buildState = useCallback(() => ({
        projectName, inspectionDate, propertyCity, eventContext, scopeNote, residentNotes,
        hdrCollapsed,
        pages: pages.map(serializePage),
        activePageId,
        items: items.map(serializeItem),
        counts: counts.current,
        view
      }), [projectName, inspectionDate, propertyCity, eventContext, scopeNote, residentNotes, hdrCollapsed, pages, activePageId, items, view]);

      const saveState = useCallback((source="manual") => {
        try{
          localStorage.setItem(STORAGE_KEY, JSON.stringify(buildState()));
          setLastSavedAt({ source, time: new Date().toLocaleTimeString() });
          setSaveError(null);
        }catch(e){
          setSaveError("Save failed (storage limit). Try removing large backgrounds or photos.");
          console.warn("Save failed", e);
        }
      }, [buildState]);

      useEffect(() => {
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        try{
          const s = JSON.parse(raw);
          setProjectName(s.projectName || "Enter Name");
          setInspectionDate(s.inspectionDate || "");
          setPropertyCity(s.propertyCity || "Houston, Texas");
          setEventContext(s.eventContext || "Moisture Intrusion Assessment");
          setScopeNote(s.scopeNote || "Interior observations and moisture-related conditions.");
          setResidentNotes(s.residentNotes || "");
          setHdrCollapsed(s.hdrCollapsed ?? true);
          setView(s.view || { scale:1, tx:0, ty:0 });
          let fallbackPageId = defaultPage.id;
          if(Array.isArray(s.pages) && s.pages.length){
            const revivedPages = s.pages.map(page => ({
              ...page,
              bg: page.bg?.dataUrl ? { name: page.bg.name || "Background", url: page.bg.dataUrl, dataUrl: page.bg.dataUrl } : null
            }));
            setPages(revivedPages);
            fallbackPageId = s.activePageId || revivedPages[0]?.id || fallbackPageId;
            setActivePageId(fallbackPageId);
          }
          if(Array.isArray(s.items)){
            const revived = s.items.map(it => ({
              ...it,
              type: it.type === "src" ? "note" : it.type,
              pageId: it.pageId || fallbackPageId,
              locked: it.locked ?? false,
              data: {
                ...it.data,
                lineType: it.data?.lineType || "plumbing",
                photo: it.data?.photo?.dataUrl ? reviveFileObj(it.data.photo) : null
              }
            }));
            setItems(revived);
          }
          if(s.counts) counts.current = { aoi:1, area:1, read:1, line:1, note:1, ...s.counts };
        }catch(e){
          console.warn("Restore failed", e);
        }
      }, []);

      useEffect(() => {
        const id = setInterval(() => saveState("auto"), 5*60*1000);
        return () => clearInterval(id);
      }, [saveState]);

      // ===== toolbar drag =====
      const clampToolbarPos = useCallback((pos) => {
        const zone = document.querySelector(".canvasZone")?.getBoundingClientRect();
        const tb = toolbarRef.current?.getBoundingClientRect();
        if(!zone || !tb) return pos;
        const pad = 10;
        const minX = zone.left + pad;
        const minY = zone.top + pad;
        const maxX = zone.right - tb.width - pad;
        const maxY = zone.bottom - tb.height - pad;
        return { x: clamp(pos.x, minX, Math.max(minX, maxX)), y: clamp(pos.y, minY, Math.max(minY, maxY)) };
      }, []);

      useEffect(() => {
        const onResize = () => {
          setIsMobile(window.innerWidth <= 820);
          setToolbarPos(p => clampToolbarPos(p));
        };
        window.addEventListener("resize", onResize);
        return () => window.removeEventListener("resize", onResize);
      }, [clampToolbarPos]);

      useEffect(() => { setToolbarPos(p => clampToolbarPos(p)); }, [clampToolbarPos]);

      const onToolbarDown = (e) => {
        if(e.button !== 0) return;
        if(toolbarLocked) return;
        if(e.target.closest("button") || e.target.closest(".lockIcon")) return;
        e.preventDefault();
        toolbarDragRef.current = { sx:e.clientX, sy:e.clientY, ox:toolbarPos.x, oy:toolbarPos.y };
        setToolbarDragging(true);
        try{ e.currentTarget.setPointerCapture(e.pointerId); }catch{}
      };
      const onToolbarMove = (e) => {
        if(!toolbarDragRef.current) return;
        const { sx, sy, ox, oy } = toolbarDragRef.current;
        setToolbarPos(clampToolbarPos({ x: ox + (e.clientX - sx), y: oy + (e.clientY - sy) }));
      };
      const onToolbarUp = (e) => {
        if(!toolbarDragRef.current) return;
        toolbarDragRef.current = null;
        setToolbarDragging(false);
        try{ e.currentTarget.releasePointerCapture(e.pointerId); }catch{}
      };
      const onToolbarCancel = (e) => {
        if(!toolbarDragRef.current) return;
        toolbarDragRef.current = null;
        setToolbarDragging(false);
        try{ e.currentTarget.releasePointerCapture(e.pointerId); }catch{}
      };

      // ===== view transforms =====
      const setScaleAnchored = (nextScale, anchorClient) => {
        const v = viewportRef.current?.getBoundingClientRect();
        if(!v) return;
        const scale = clamp(nextScale, 0.40, 3.0);
        if(!anchorClient){
          setView(prev => ({ ...prev, scale }));
          return;
        }
        setView(prev => {
          const ax = anchorClient.x - v.left;
          const ay = anchorClient.y - v.top;
          const s0 = prev.scale;
          const s1 = scale;
          const dx = ax - v.width/2 - prev.tx;
          const dy = ay - v.height/2 - prev.ty;
          return {
            scale: s1,
            tx: prev.tx + dx * (1 - s1/s0),
            ty: prev.ty + dy * (1 - s1/s0),
          };
        });
      };
      const zoomIn = () => setScaleAnchored(view.scale * 1.15);
      const zoomOut = () => setScaleAnchored(view.scale / 1.15);
      const zoomReset = () => setView({ scale:1.0, tx:0, ty:0 });

      // ===== canvas interactions =====
      const clientToSheet = (clientX, clientY) => {
        const v = viewportRef.current?.getBoundingClientRect();
        if(!v) return null;
        const sheetW = 1024, sheetH = 720;

        // stage is centered at viewport center + view tx/ty, then scaled, with sheet anchored at (0,0) stage origin.
        const x = (clientX - v.left - v.width/2 - view.tx) / view.scale + sheetW/2;
        const y = (clientY - v.top  - v.height/2 - view.ty) / view.scale + sheetH/2;

        return { x: clamp(x/sheetW, 0, 1), y: clamp(y/sheetH, 0, 1) };
      };

      const createItem = (type, pos) => {
        const id = uid();
        const n = counts.current[type]++;

        const base = {
          id,
          type,
          name: "",
          x: pos.x,
          y: pos.y,
          pageId: activePageId,
          data: {
            room: "Living",
            elevation: "Wall",
            condition: "Moisture staining (spot)",
            extent: "",
            measurements: "",
            instrument: "Pin meter",
            reading: "",
            units: "WME",
            tags: "",
            notes: "",
            photo: null,
            photoCaption: "",
            lineType: "plumbing"
          },
          locked: false
        };

        if(type === "aoi"){
          base.name = `AOI-${n}`;
          base.data = { ...base.data, notes: "Area of interest. Describe observed condition(s), moisture pattern, and nearby features." };
        }
        if(type === "area"){
          base.name = `AOI-A${n}`;
          base.data = { ...base.data, notes: "AOI area polygon. Outline the visible condition and capture measurements." };
        }
        if(type === "read"){
          base.name = `MR-${n}`;
          base.data = { ...base.data, condition: "Moisture staining (spot)", notes: "Document reading location, substrate, and instrument type/model." };
        }
        if(type === "note"){
          base.name = `NOTE-${n}`;
          base.data = { ...base.data, elevation:"Other", condition:"Other", notes: "General note (odors, occupant statements, recent repairs, environmental conditions, etc.)." };
        }
        if(type === "line"){
          base.name = `LINE-${n}`;
          base.data = { ...base.data, elevation:"Other", condition:"Other", notes: "Line annotation for plumbing or drain routing." };
        }
        return base;
      };

      const markerColorClass = (t) => (t === "aoi" ? "aoi" : t === "read" ? "read" : "note");

      const polygonCenter = (points) => {
        if(!points?.length) return { x: 0.5, y: 0.5 };
        const sum = points.reduce((acc, p) => ({ x: acc.x + p.x, y: acc.y + p.y }), { x:0, y:0 });
        return { x: sum.x / points.length, y: sum.y / points.length };
      };

      const lineMidpoint = (line) => ({
        x: (line.x1 + line.x2) / 2,
        y: (line.y1 + line.y2) / 2
      });

      const addAtClick = (e) => {
        if(suppressClickRef.current){
          suppressClickRef.current = false;
          return;
        }
        if(tool === "pan") return;
        const hitMarker = e.target.closest("[data-marker-id]");
        const hitArea = e.target.closest(".areaLabel") || e.target.closest(".areaPolyClickable");
        const hitLine = e.target.closest("[data-line-id]");
        if(hitMarker) return;
        if(hitArea) return;
        if(hitLine) return;
        const p = clientToSheet(e.clientX, e.clientY);
        if(!p) return;
        if(tool === "area"){
          setDraftPolygon(prev => {
            if(!prev || prev.pageId !== activePageId){
              return { pageId: activePageId, points: [p] };
            }
            return { ...prev, points: [...prev.points, p] };
          });
          return;
        }
        if(tool === "line"){
          if(!draftLine || draftLine.pageId !== activePageId){
            setDraftLine({ pageId: activePageId, start: p, end: p });
            return;
          }
          const it = {
            ...createItem("line", p),
            line: { x1: draftLine.start.x, y1: draftLine.start.y, x2: p.x, y2: p.y }
          };
          setItems(prev => [...prev, it]);
          setSelectedId(it.id);
          setDraftLine(null);
          if(isMobile) setMobilePanelOpen(true);
          return;
        }
        const it = createItem(tool, p);
        setItems(prev => [...prev, it]);
        setSelectedId(it.id);
        if(isMobile) setMobilePanelOpen(true);
      };

      const finishPolygon = () => {
        if(!draftPolygon || draftPolygon.points.length < 3) return;
        const center = polygonCenter(draftPolygon.points);
        const it = { ...createItem("area", center), points: draftPolygon.points, pageId: activePageId };
        setItems(prev => [...prev, it]);
        setSelectedId(it.id);
        setDraftPolygon(null);
        if(isMobile) setMobilePanelOpen(true);
      };

      const cancelPolygon = () => setDraftPolygon(null);

      const finishLine = () => {
        if(!draftLine?.start || !draftLine?.end) return;
        const it = {
          ...createItem("line", draftLine.end),
          line: { x1: draftLine.start.x, y1: draftLine.start.y, x2: draftLine.end.x, y2: draftLine.end.y }
        };
        setItems(prev => [...prev, it]);
        setSelectedId(it.id);
        setDraftLine(null);
        if(isMobile) setMobilePanelOpen(true);
      };

      const cancelLine = () => setDraftLine(null);

      const onPointerDown = (e) => {
        const markerEl = e.target.closest("[data-marker-id]");
        if(markerEl){
          const id = markerEl.getAttribute("data-marker-id");
          const item = items.find(i => i.id === id);
          suppressClickRef.current = true;
          setSelectedId(id);
          if(item?.locked) return;
          if(tool === "pan") {
            // allow pan even if pressing marker? keep pan on viewport background only
          } else {
            // drag marker
            e.preventDefault();
            setDrag({ mode:"move", id, sx:e.clientX, sy:e.clientY, moved:false });
            try{ e.currentTarget.setPointerCapture(e.pointerId); }catch{}
          }
          return;
        }
        const areaEl = e.target.closest(".areaLabel") || e.target.closest(".areaPolyClickable");
        if(areaEl){
          const id = areaEl.getAttribute("data-area-id") || areaEl.getAttribute("data-marker-id");
          const item = items.find(i => i.id === id);
          suppressClickRef.current = true;
          setSelectedId(id);
          if(item?.locked) return;
          e.preventDefault();
          setDrag({ mode:"moveArea", id, sx:e.clientX, sy:e.clientY, points: item?.points || [], moved:false });
          try{ e.currentTarget.setPointerCapture(e.pointerId); }catch{}
          return;
        }
        const lineEl = e.target.closest("[data-line-id]");
        if(lineEl){
          const id = lineEl.getAttribute("data-line-id");
          const item = items.find(i => i.id === id);
          suppressClickRef.current = true;
          setSelectedId(id);
          if(item?.locked) return;
          e.preventDefault();
          setDrag({ mode:"moveLine", id, sx:e.clientX, sy:e.clientY, line: item?.line, moved:false });
          try{ e.currentTarget.setPointerCapture(e.pointerId); }catch{}
          return;
        }

        if(tool === "pan"){
          e.preventDefault();
          setDrag({ mode:"pan", sx:e.clientX, sy:e.clientY, ox:view.tx, oy:view.ty });
          try{ e.currentTarget.setPointerCapture(e.pointerId); }catch{}
        }
      };

      const onPointerMove = (e) => {
        if(!drag){
          if(draftLine && tool === "line"){
            const p = clientToSheet(e.clientX, e.clientY);
            if(p){
              setDraftLine(prev => prev ? ({ ...prev, end: p }) : prev);
            }
          }
          return;
        }
        if(drag.mode === "pan"){
          if(!drag.moved && (Math.abs(e.clientX - drag.sx) > 2 || Math.abs(e.clientY - drag.sy) > 2)){
            setDrag(prev => prev ? ({ ...prev, moved:true }) : prev);
            suppressClickRef.current = true;
          }
          setView(prev => ({ ...prev, tx: drag.ox + (e.clientX - drag.sx), ty: drag.oy + (e.clientY - drag.sy) }));
        }
        if(drag.mode === "move"){
          if(!drag.moved && (Math.abs(e.clientX - drag.sx) > 2 || Math.abs(e.clientY - drag.sy) > 2)){
            setDrag(prev => prev ? ({ ...prev, moved:true }) : prev);
            suppressClickRef.current = true;
          }
          const v = viewportRef.current?.getBoundingClientRect();
          if(!v) return;
          const sheetW = 1024, sheetH = 720;

          // compute delta in sheet space
          const dxClient = e.clientX - drag.sx;
          const dyClient = e.clientY - drag.sy;
          const dxSheet = dxClient / view.scale;
          const dySheet = dyClient / view.scale;

          setItems(prev => prev.map(it => {
            if(it.id !== drag.id) return it;
            const xAbs = it.x * sheetW + dxSheet;
            const yAbs = it.y * sheetH + dySheet;
            return { ...it, x: clamp(xAbs/sheetW, 0, 1), y: clamp(yAbs/sheetH, 0, 1) };
          }));
          // update drag start so movement feels stable
          setDrag(d => d ? ({ ...d, sx:e.clientX, sy:e.clientY }) : d);
        }
        if(drag.mode === "moveArea"){
          if(!drag.moved && (Math.abs(e.clientX - drag.sx) > 2 || Math.abs(e.clientY - drag.sy) > 2)){
            setDrag(prev => prev ? ({ ...prev, moved:true }) : prev);
            suppressClickRef.current = true;
          }
          const v = viewportRef.current?.getBoundingClientRect();
          if(!v) return;
          const sheetW = 1024, sheetH = 720;
          const dxClient = e.clientX - drag.sx;
          const dyClient = e.clientY - drag.sy;
          const dxSheet = dxClient / view.scale / sheetW;
          const dySheet = dyClient / view.scale / sheetH;
          setItems(prev => prev.map(it => {
            if(it.id !== drag.id) return it;
            if(!Array.isArray(it.points)) return it;
            const movedPoints = drag.points.map(p => ({
              x: clamp(p.x + dxSheet, 0, 1),
              y: clamp(p.y + dySheet, 0, 1)
            }));
            return { ...it, points: movedPoints };
          }));
        }
        if(drag.mode === "moveLine"){
          if(!drag.moved && (Math.abs(e.clientX - drag.sx) > 2 || Math.abs(e.clientY - drag.sy) > 2)){
            setDrag(prev => prev ? ({ ...prev, moved:true }) : prev);
            suppressClickRef.current = true;
          }
          const v = viewportRef.current?.getBoundingClientRect();
          if(!v || !drag.line) return;
          const sheetW = 1024, sheetH = 720;
          const dxClient = e.clientX - drag.sx;
          const dyClient = e.clientY - drag.sy;
          const dxSheet = dxClient / view.scale / sheetW;
          const dySheet = dyClient / view.scale / sheetH;
          setItems(prev => prev.map(it => {
            if(it.id !== drag.id || !it.line) return it;
            return {
              ...it,
              line: {
                x1: clamp(drag.line.x1 + dxSheet, 0, 1),
                y1: clamp(drag.line.y1 + dySheet, 0, 1),
                x2: clamp(drag.line.x2 + dxSheet, 0, 1),
                y2: clamp(drag.line.y2 + dySheet, 0, 1)
              }
            };
          }));
        }
      };

      const onPointerUp = (e) => {
        if(!drag) return;
        setDrag(null);
        try{ e.currentTarget.releasePointerCapture(e.pointerId); }catch{}
      };
      const onPointerCancel = (e) => {
        if(!drag) return;
        setDrag(null);
        try{ e.currentTarget.releasePointerCapture(e.pointerId); }catch{}
      };

      const onWheel = (e) => {
        e.preventDefault();
        const isZoom = e.ctrlKey || e.metaKey;
        if(isZoom){
          const delta = -e.deltaY;
          const factor = delta > 0 ? 1.08 : 1/1.08;
          setScaleAnchored(view.scale * factor, { x: e.clientX, y: e.clientY });
        } else {
          setView(prev => ({ ...prev, tx: prev.tx - e.deltaX, ty: prev.ty - e.deltaY }));
        }
      };

      const onDoubleClick = (e) => {
        if(tool !== "area") return;
        e.preventDefault();
        finishPolygon();
      };

      const group = useMemo(() => {
        const g = { aoi: [], area: [], read: [], line: [], note: [] };
        activeItems.forEach(it => g[it.type]?.push(it));
        return g;
      }, [activeItems]);

      const [groupOpen, setGroupOpen] = useState({ aoi:true, area:true, read:true, line:true, note:true });

      const addPage = () => {
        const nextIndex = pages.length + 1;
        const newPage = { id: uid(), name: `Page ${nextIndex}`, bg: null };
        setPages(prev => [...prev, newPage]);
        setActivePageId(newPage.id);
        setSelectedId(null);
      };

      const duplicatePage = () => {
        if(!activePage) return;
        const nextIndex = pages.length + 1;
        const newPage = {
          id: uid(),
          name: `${activePage.name || `Page ${nextIndex}`} Copy`,
          bg: activePage.bg ? { ...activePage.bg } : null
        };
        setPages(prev => [...prev, newPage]);
        const pageItems = items.filter(it => it.pageId === activePage.id).map(it => ({ ...it, id: uid(), pageId: newPage.id }));
        setItems(prev => [...prev, ...pageItems]);
        setActivePageId(newPage.id);
        setSelectedId(null);
      };

      const deletePage = () => {
        if(pages.length <= 1) return;
        if(!confirm("Delete this page and its items?")) return;
        const remaining = pages.filter(p => p.id !== activePageId);
        setPages(remaining);
        setItems(prev => prev.filter(it => it.pageId !== activePageId));
        setActivePageId(remaining[0]?.id);
        setSelectedId(null);
      };

      const goPrevPage = () => {
        if(activePageIndex <= 0) return;
        const prevPage = pages[activePageIndex - 1];
        if(prevPage){
          setActivePageId(prevPage.id);
          setSelectedId(null);
        }
      };

      const goNextPage = () => {
        if(activePageIndex < 0 || activePageIndex >= pages.length - 1) return;
        const nextPage = pages[activePageIndex + 1];
        if(nextPage){
          setActivePageId(nextPage.id);
          setSelectedId(null);
        }
      };

      const deleteActive = () => {
        if(!selectedId) return;
        setItems(prev => prev.filter(i => i.id !== selectedId));
        setSelectedId(null);
      };

      const clearAll = () => {
        if(!confirm("Clear all TitanMoisture notes? (This will also clear saved state)")) return;
        setItems([]);
        setSelectedId(null);
        setPages([defaultPage]);
        setActivePageId(defaultPage.id);
        counts.current = { aoi:1, area:1, read:1, line:1, note:1 };
        localStorage.removeItem(STORAGE_KEY);
        setLastSavedAt(null);
        setSaveError(null);
      };

      const setActivePhoto = async (file) => {
        if(!activeItem) return;
        const obj = await fileToObj(file);
        setItems(prev => prev.map(i => i.id === activeItem.id ? ({ ...i, data: { ...i.data, photo: obj } }) : i));
      };

      const updateActive = (k, v) => {
        if(!activeItem) return;
        setItems(prev => prev.map(i => i.id === activeItem.id ? ({ ...i, data: { ...i.data, [k]: v } }) : i));
      };

      const exportPdf = () => {
        window.print();
      };

      // simple grid overlay lines
      const Grid = () => {
        const lines = [];
        for(let i=1;i<12;i++){
          const x = (i/12)*1024;
          lines.push(<line key={"vx"+i} x1={x} y1={0} x2={x} y2={720} className={i%3===0 ? "major" : ""} />);
        }
        for(let j=1;j<8;j++){
          const y = (j/8)*720;
          lines.push(<line key={"hy"+j} x1={0} y1={y} x2={1024} y2={y} className={j%2===0 ? "major" : ""} />);
        }
        return (
          <svg className="sheetGrid" width="1024" height="720" viewBox="0 0 1024 720">
            {lines}
          </svg>
        );
      };

      // header summary
      const metaLine2 = `${eventContext}${inspectionDate ? "  " + inspectionDate : ""}`;
      const metaLine3 = `${propertyCity}`;
      const typeLabels = { aoi: "AOI Marker", area: "AOI Area", read: "Moisture Reading", line: "Line", note: "Note" };

      return (
        <>
          <div className={"app" + (panelCollapsed ? " panelCollapsed" : "")}>
          {/* canvas */}
          <div className="canvasZone">
            <div
              ref={toolbarRef}
              className={"toolbar" + (toolbarLocked ? " locked" : "") + (toolbarDragging ? " dragging" : "")}
              style={{ left: toolbarPos.x, top: toolbarPos.y }}
              onPointerDown={onToolbarDown}
              onPointerMove={onToolbarMove}
              onPointerUp={onToolbarUp}
              onPointerCancel={onToolbarCancel}
            >
              <div className="tbCenter">
                <div className="tbTitle">TitanMoisture  Tools</div>
                <div className="tbTools">
                  <button className={"toolBtn aoi expanded" + (tool==="aoi" ? " active" : "")} onClick={() => setTool("aoi")}><span className="toolText">AOI</span></button>
                  <button className={"toolBtn aoi expanded" + (tool==="area" ? " active" : "")} onClick={() => setTool("area")}><span className="toolText">AREA</span></button>
                  <button className={"toolBtn read expanded" + (tool==="read" ? " active" : "")} onClick={() => setTool("read")}><span className="toolText">MR</span></button>
                  <button className={"toolBtn read expanded" + (tool==="line" ? " active" : "")} style={{"--toolColor":"var(--c-ds)"}} onClick={() => setTool("line")}><span className="toolText">LINE</span></button>
                  <button className={"toolBtn note expanded" + (tool==="note" ? " active" : "")} onClick={() => setTool("note")}><span className="toolText">NOTE</span></button>
                  <div className="tbDivider"></div>
                  <button className={"toolBtn note expanded" + (tool==="pan" ? " active" : "")} style={{"--toolColor":"var(--navy)"}}
                          onClick={() => setTool("pan")}><span className="toolText">PAN</span></button>
                  {tool === "area" && (
                    <>
                      <button className={"toolBtn aoi expanded"} disabled={!draftPolygon || draftPolygon.points.length < 3} onClick={finishPolygon}>
                        <span className="toolText">Finish</span>
                      </button>
                      <button className={"toolBtn note expanded"} style={{"--toolColor":"var(--c-apt)"}} onClick={cancelPolygon}>
                        <span className="toolText">Cancel</span>
                      </button>
                    </>
                  )}
                  {tool === "line" && (
                    <>
                      <button className={"toolBtn read expanded"} disabled={!draftLine?.start || !draftLine?.end} onClick={finishLine}>
                        <span className="toolText">Finish</span>
                      </button>
                      <button className={"toolBtn note expanded"} style={{"--toolColor":"var(--c-apt)"}} onClick={cancelLine}>
                        <span className="toolText">Cancel</span>
                      </button>
                    </>
                  )}
                  <div className={"lockIcon " + (toolbarLocked ? "locked" : "unlocked")} title={toolbarLocked ? "Locked" : "Unlocked"}
                       onClick={() => setToolbarLocked(v => !v)}>
                    {toolbarLocked ? <Icon name="lock" /> : <Icon name="unlock" />}
                  </div>
                </div>
              </div>
            </div>

            <div className="navTools">
              <div className="navCard">
                <div className="navRow">
                  <div className="zBtns">
                    <button className="zBtn" onClick={zoomOut}></button>
                    <button className="zBtn" onClick={zoomIn}>+</button>
                    <button className="zBtn" onClick={zoomReset}>Reset</button>
                  </div>
                  <div className="zReadout">{Math.round(view.scale*100)}%</div>
                </div>
                <div className="hint">
                  Tap to place: <b>AOI</b> (purple), <b>AREA</b> polygons, <b>MR</b> readings (blue), <b>LINE</b> runs (blue/gray), <b>NOTE</b> (charcoal). Use <b>PAN</b> to move the sheet. Double-tap or click Finish to close a polygon.
                </div>
              </div>
            </div>

            <div
              ref={viewportRef}
              className="viewport"
              onClick={addAtClick}
              onPointerDown={onPointerDown}
              onPointerMove={onPointerMove}
              onPointerUp={onPointerUp}
              onPointerCancel={onPointerCancel}
              onWheel={onWheel}
              onDoubleClick={onDoubleClick}
            >
              <div
                ref={stageRef}
                className="stage"
                style={{
                  transform: `translate(${view.tx}px, ${view.ty}px) scale(${view.scale}) translate(-512px, -360px)`
                }}
              >
                <div className="sheet" ref={sheetRef}>
                  {activePage?.bg?.url ? <img className="sheetBg" src={activePage.bg.url} alt="background" /> : null}
                  <Grid />

                  <svg className="sheetOverlay" width="1024" height="720" viewBox="0 0 1024 720">
                    {activeItems.filter(it => it.type === "area" && Array.isArray(it.points)).map(it => (
                      <polygon
                        key={it.id}
                        className="areaPoly areaPolyClickable"
                        points={it.points.map(p => `${p.x*1024},${p.y*720}`).join(" ")}
                        data-area-id={it.id}
                        onClick={(e) => { e.stopPropagation(); setSelectedId(it.id); if(isMobile) setMobilePanelOpen(true); }}
                      />
                    ))}
                    {activeItems.filter(it => it.type === "line" && it.line).map(it => (
                      <line
                        key={it.id}
                        className={`lineStroke ${it.data.lineType === "drain" ? "drain" : ""}`}
                        x1={it.line.x1*1024}
                        y1={it.line.y1*720}
                        x2={it.line.x2*1024}
                        y2={it.line.y2*720}
                        data-line-id={it.id}
                        onClick={(e) => { e.stopPropagation(); setSelectedId(it.id); if(isMobile) setMobilePanelOpen(true); }}
                      />
                    ))}
                    {draftPolygon?.pageId === activePageId && draftPolygon.points.length > 0 && (
                      <>
                        <polygon
                          className="areaPoly draft"
                          points={draftPolygon.points.map(p => `${p.x*1024},${p.y*720}`).join(" ")}
                        />
                        {draftPolygon.points.map((p, idx) => (
                          <circle key={`pt-${idx}`} className="areaPoint" cx={p.x*1024} cy={p.y*720} r="5" />
                        ))}
                      </>
                    )}
                    {draftLine?.pageId === activePageId && draftLine.start && draftLine.end && (
                      <line
                        className="lineStroke"
                        x1={draftLine.start.x*1024}
                        y1={draftLine.start.y*720}
                        x2={draftLine.end.x*1024}
                        y2={draftLine.end.y*720}
                      />
                    )}
                  </svg>

                  {activeItems.filter(it => it.type === "area" && Array.isArray(it.points)).map(it => {
                    const center = polygonCenter(it.points);
                    return (
                      <div
                        key={`${it.id}-label`}
                        className={"areaLabel" + (it.id === selectedId ? " selected" : "")}
                        style={{ left: `${center.x*100}%`, top: `${center.y*100}%` }}
                        data-area-id={it.id}
                        onClick={(e) => { e.stopPropagation(); setSelectedId(it.id); if(isMobile) setMobilePanelOpen(true); }}
                      >
                        {it.name}
                      </div>
                    );
                  })}

                  {activeItems.filter(it => it.type === "line" && it.line).map(it => {
                    const mid = lineMidpoint(it.line);
                    return (
                      <div
                        key={`${it.id}-line-label`}
                        className={`lineLabel ${it.data.lineType === "drain" ? "drain" : ""}` + (it.id === selectedId ? " selected" : "")}
                        style={{ left: `${mid.x*100}%`, top: `${mid.y*100}%` }}
                        data-line-id={it.id}
                        onClick={(e) => { e.stopPropagation(); setSelectedId(it.id); if(isMobile) setMobilePanelOpen(true); }}
                      >
                        {it.name}
                      </div>
                    );
                  })}

                  {activeItems.filter(it => it.type !== "area" && it.type !== "line").map(it => (
                    <div
                      key={it.id}
                      data-marker-id={it.id}
                      className={"marker " + markerColorClass(it.type) + (it.id === selectedId ? " selected" : "")}
                      style={{ left: `${it.x*100}%`, top: `${it.y*100}%` }}
                      title={it.name}
                      onClick={(e) => { e.stopPropagation(); setSelectedId(it.id); if(isMobile) setMobilePanelOpen(true); }}
                    >
                      {it.name.split("-")[0]}
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {/* mobile controls */}
            {isMobile && (
              <>
                <div className={"panelOverlay" + (mobilePanelOpen ? " show" : "")} onClick={() => setMobilePanelOpen(false)}></div>
                <div className="mobileDock">
                  <button className="btn btnPrimary" onClick={() => setMobilePanelOpen(true)}>Properties</button>
                  <button className="btn" onClick={() => setTool("pan")}>Pan</button>
                </div>
              </>
            )}
          </div>

          {/* sidebar */}
          <div className={"panel" + (panelCollapsed ? " collapsed" : "") + (isMobile && mobilePanelOpen ? " mobileOpen" : "")}>
            {!isMobile && (
              <button className="panelToggle" onClick={() => setPanelCollapsed(v => !v)} title={panelCollapsed ? "Expand sidebar" : "Collapse sidebar"}>
                <Icon name={panelCollapsed ? "chevLeft" : "chevRight"} />
              </button>
            )}
            <div className="panelContent">
              <div className="pHeader">
                <div>
                  <div className="hdrLine0">TitanMoisture  Version 0.2</div>
                  <div className="hdrLine1">
                    <span>{projectName}</span>
                    <button className="hdrIconInline" onClick={() => setHdrCollapsed(v => !v)} title={hdrCollapsed ? "Expand details" : "Collapse details"}>
                      <Icon name={hdrCollapsed ? "chevDown" : "chevUp"} />
                    </button>
                  </div>
                  {!hdrCollapsed && (
                    <>
                      <div className="hdrLine2">{metaLine2}</div>
                      <div className="hdrLine3">{metaLine3}</div>
                    </>
                  )}
                </div>

                <div className="hdrActions">
                  {isMobile && <button className="hdrBtn" onClick={() => setMobilePanelOpen(false)}>Close</button>}
                  <button className="hdrBtn" onClick={() => setHdrEditOpen(v => !v)}>
                    <Icon name="pencil" /> {hdrEditOpen ? "Done" : "Edit"}
                  </button>
                  <button className="hdrBtn" onClick={() => saveState("manual")}>
                    <Icon name="save" /> Save
                  </button>
                  <button className="hdrBtn" onClick={exportPdf}>
                    <Icon name="export" /> Export
                  </button>
                  <button className="hdrBtn danger" onClick={clearAll}>
                    <Icon name="trash" /> Reset
                  </button>
                  <div className={"hdrSaveMeta" + (saveError ? " error" : "")}>
                    {saveError || (lastSavedAt ? `${lastSavedAt.source === "auto" ? "Auto saved" : "Last saved"} ${lastSavedAt.time}` : "Not saved yet")}
                  </div>
                </div>
              </div>

              <div className="pScroll">
              {hdrEditOpen && (
                <div className="card editCard">
                  <div className="lbl">Project header</div>
                  <label className="lbl" style={{marginTop:10}}>Project / Residence name</label>
                  <input className="inp" value={projectName} onChange={(e)=>setProjectName(e.target.value)} />

                  <div className="row" style={{marginTop:10}}>
                    <div>
                      <label className="lbl">Inspection date</label>
                      <input className="inp" placeholder="MM/DD/YYYY" value={inspectionDate} onChange={(e)=>setInspectionDate(e.target.value)} />
                    </div>
                    <div>
                      <label className="lbl">Location</label>
                      <input className="inp" value={propertyCity} onChange={(e)=>setPropertyCity(e.target.value)} />
                    </div>
                  </div>

                  <label className="lbl" style={{marginTop:10}}>Context</label>
                  <input className="inp" value={eventContext} onChange={(e)=>setEventContext(e.target.value)} />

                  <label className="lbl" style={{marginTop:10}}>Scope note</label>
                  <textarea className="inp" value={scopeNote} onChange={(e)=>setScopeNote(e.target.value)} />

                  <div className="hr"></div>
                  <div className="lbl">Background (per page)</div>
                  <div className="tiny">Upload a photo or quick floor plan screenshot for reference (per page).</div>
                  <div style={{marginTop:10}}>
                    <label className="btn btnPrimary" style={{display:"inline-flex", cursor:"pointer"}}>
                      Upload Background
                      <input type="file" accept="image/*" style={{display:"none"}}
                        onChange={async (e) => {
                          const f = e.target.files?.[0];
                          if(!f) return;
                          const obj = await fileToObj(f);
                          setPages(prev => prev.map(p => p.id === activePageId ? ({ ...p, bg: obj }) : p));
                          e.target.value = "";
                        }}
                      />
                    </label>
                    {activePage?.bg?.name && <div className="tiny" style={{marginTop:8}}>Loaded: <b>{activePage.bg.name}</b></div>}
                    {activePage?.bg && (
                      <div style={{marginTop:10}}>
                        <button className="btn btnDanger" onClick={() => setPages(prev => prev.map(p => p.id === activePageId ? ({ ...p, bg: null }) : p))}>Remove Background</button>
                      </div>
                    )}
                  </div>

                  <label className="lbl" style={{marginTop:12}}>Resident / client statement</label>
                  <textarea className="inp" placeholder="Notes shared by homeowner/resident/client (exported in PDF)."
                            value={residentNotes} onChange={(e)=>setResidentNotes(e.target.value)} />
                </div>
              )}

              <div className="card">
                <div className="lbl">Pages / floors</div>
                <div className="tiny">Add multiple pages to document observations across floors or areas.</div>
                <label className="lbl" style={{marginTop:10}}>Active page name</label>
                <input className="inp" value={activePage?.name || ""} onChange={(e) => {
                  const v = e.target.value;
                  setPages(prev => prev.map(p => p.id === activePageId ? ({ ...p, name: v }) : p));
                }} />
                <div className="row" style={{marginTop:10}}>
                  <button className="btn" onClick={goPrevPage} disabled={activePageIndex <= 0}>Prev</button>
                  <select
                    className="inp"
                    value={activePageId}
                    onChange={(e) => { setActivePageId(e.target.value); setSelectedId(null); }}
                  >
                    {pages.map(page => (
                      <option key={page.id} value={page.id}>
                        {page.name || "Untitled"}
                      </option>
                    ))}
                  </select>
                  <button className="btn" onClick={goNextPage} disabled={activePageIndex >= pages.length - 1}>Next</button>
                </div>
                <div className="row" style={{marginTop:10}}>
                  <button className="btn btnPrimary" onClick={addPage}>Add Page</button>
                  <button className="btn" onClick={duplicatePage}>Duplicate</button>
                  <button className="btn btnDanger" onClick={deletePage} disabled={pages.length <= 1}>Delete</button>
                </div>
              </div>

              {/* Items list */}
              <div className="card">
                <div className="lbl">Items</div>
                <div className="tiny">Select an item below, or place new markers/polygons on the sheet using the toolbar.</div>

                <div style={{marginTop:12}}>
                  <div className={"groupHeader aoi"} onClick={() => setGroupOpen(s => ({...s, aoi: !s.aoi}))}>
                    <div className="groupTitle">
                      AOI (Areas of Interest)
                      <span className="groupCount">{group.aoi.length}</span>
                    </div>
                    <div className="groupChevron"><Icon name={groupOpen.aoi ? "chevUp" : "chevDown"} /></div>
                  </div>
                  {groupOpen.aoi && group.aoi.map(it => (
                    <div key={it.id} className={"itemRow" + (it.id===selectedId ? " selected" : "")} style={{borderLeftColor:"var(--c-aoi)"}}
                         onClick={() => { setSelectedId(it.id); if(isMobile) setMobilePanelOpen(true); }}>
                      <div className="itemInfo">
                        <b>{it.name}</b>
                        <span>{it.data.room}  {it.data.elevation}  {it.data.condition}</span>
                      </div>
                      <span className="badge">AOI</span>
                    </div>
                  ))}
                </div>

                <div style={{marginTop:12}}>
                  <div className={"groupHeader aoi"} onClick={() => setGroupOpen(s => ({...s, area: !s.area}))}>
                    <div className="groupTitle">
                      AOI Areas (Polygons)
                      <span className="groupCount">{group.area.length}</span>
                    </div>
                    <div className="groupChevron"><Icon name={groupOpen.area ? "chevUp" : "chevDown"} /></div>
                  </div>
                  {groupOpen.area && group.area.map(it => (
                    <div key={it.id} className={"itemRow" + (it.id===selectedId ? " selected" : "")} style={{borderLeftColor:"var(--c-aoi)"}}
                         onClick={() => { setSelectedId(it.id); if(isMobile) setMobilePanelOpen(true); }}>
                      <div className="itemInfo">
                        <b>{it.name}</b>
                        <span>{it.data.room}  {it.data.elevation}  {it.data.condition}</span>
                      </div>
                      <span className="badge">AOI Area</span>
                    </div>
                  ))}
                </div>

                <div style={{marginTop:12}}>
                  <div className={"groupHeader read"} onClick={() => setGroupOpen(s => ({...s, read: !s.read}))}>
                    <div className="groupTitle">
                      MR (Moisture Readings)
                      <span className="groupCount">{group.read.length}</span>
                    </div>
                    <div className="groupChevron"><Icon name={groupOpen.read ? "chevUp" : "chevDown"} /></div>
                  </div>
                  {groupOpen.read && group.read.map(it => (
                    <div key={it.id} className={"itemRow" + (it.id===selectedId ? " selected" : "")} style={{borderLeftColor:"var(--c-read)"}}
                         onClick={() => { setSelectedId(it.id); if(isMobile) setMobilePanelOpen(true); }}>
                      <div className="itemInfo">
                        <b>{it.name}</b>
                        <span>{it.data.room}  {it.data.reading ? (it.data.reading + " " + it.data.units) : "Reading not entered"}</span>
                      </div>
                      <span className="badge">MR</span>
                    </div>
                  ))}
                </div>

                <div style={{marginTop:12}}>
                  <div className={"groupHeader line"} onClick={() => setGroupOpen(s => ({...s, line: !s.line}))}>
                    <div className="groupTitle">
                      Lines
                      <span className="groupCount">{group.line.length}</span>
                    </div>
                    <div className="groupChevron"><Icon name={groupOpen.line ? "chevUp" : "chevDown"} /></div>
                  </div>
                  {groupOpen.line && group.line.map(it => (
                    <div key={it.id} className={"itemRow" + (it.id===selectedId ? " selected" : "")} style={{borderLeftColor:"var(--c-read)"}}
                         onClick={() => { setSelectedId(it.id); if(isMobile) setMobilePanelOpen(true); }}>
                      <div className="itemInfo">
                        <b>{it.name}</b>
                        <span>{it.data.room}  {it.data.lineType === "drain" ? "Drain line" : "Plumbing line"}</span>
                      </div>
                      <span className="badge">LINE</span>
                    </div>
                  ))}
                </div>

                <div style={{marginTop:12}}>
                  <div className={"groupHeader note"} onClick={() => setGroupOpen(s => ({...s, note: !s.note}))}>
                    <div className="groupTitle">
                      Notes
                      <span className="groupCount">{group.note.length}</span>
                    </div>
                    <div className="groupChevron"><Icon name={groupOpen.note ? "chevUp" : "chevDown"} /></div>
                  </div>
                  {groupOpen.note && group.note.map(it => (
                    <div key={it.id} className={"itemRow" + (it.id===selectedId ? " selected" : "")} style={{borderLeftColor:"var(--c-note)"}}
                         onClick={() => { setSelectedId(it.id); if(isMobile) setMobilePanelOpen(true); }}>
                      <div className="itemInfo">
                        <b>{it.name}</b>
                        <span>{it.data.notes?.slice(0, 60) || ""}{(it.data.notes||"").length>60 ? "" : ""}</span>
                      </div>
                      <span className="badge">NOTE</span>
                    </div>
                  ))}
                </div>
              </div>

              {/* Properties for selected */}
              <div className="card">
                <div className="lbl">Selected item</div>
                {!activeItem ? (
                  <div className="tiny">Select a marker (or add one) to edit details.</div>
                ) : (
                  <>
                    <div className="row">
                      <div>
                        <label className="lbl">Label</label>
                        <input className="inp" value={activeItem.name} onChange={(e)=>{
                          const v = e.target.value;
                          setItems(prev => prev.map(i => i.id===activeItem.id ? ({...i, name:v}) : i));
                        }} />
                      </div>
                      <div>
                        <label className="lbl">Room</label>
                        <select className="inp" value={activeItem.data.room} onChange={(e)=>updateActive("room", e.target.value)}>
                          {ROOMS_DEFAULT.map(r => <option key={r} value={r}>{r}</option>)}
                        </select>
                      </div>
                    </div>
                    <div className="row" style={{marginTop:10}}>
                      <div>
                        <label className="lbl">Lock item</label>
                        <button
                          className={"btn btnFull " + (activeItem.locked ? "btnDanger" : "btnPrimary")}
                          onClick={() => setItems(prev => prev.map(i => i.id === activeItem.id ? ({ ...i, locked: !i.locked }) : i))}
                        >
                          {activeItem.locked ? "Locked" : "Unlocked"}
                        </button>
                      </div>
                      {activeItem.type === "line" && (
                        <div>
                          <label className="lbl">Line type</label>
                          <select className="inp" value={activeItem.data.lineType} onChange={(e)=>updateActive("lineType", e.target.value)}>
                            <option value="plumbing">Plumbing line</option>
                            <option value="drain">Drain line</option>
                          </select>
                        </div>
                      )}
                    </div>

                    <div className="row" style={{marginTop:10}}>
                      <div>
                        <label className="lbl">Elevation / component</label>
                        <select className="inp" value={activeItem.data.elevation} onChange={(e)=>updateActive("elevation", e.target.value)}>
                          {ELEVATIONS.map(r => <option key={r} value={r}>{r}</option>)}
                        </select>
                      </div>
                      <div>
                        <label className="lbl">Condition</label>
                        <select className="inp" value={activeItem.data.condition} onChange={(e)=>updateActive("condition", e.target.value)}>
                          {INTERIOR_CONDITIONS.map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                      </div>
                    </div>
                    {activeItem.type === "read" && (
                      <>
                        <div className="row" style={{marginTop:10}}>
                          <div>
                            <label className="lbl">Moisture reading</label>
                            <input className="inp" placeholder="e.g., 18" value={activeItem.data.reading} onChange={(e)=>updateActive("reading", e.target.value)} />
                          </div>
                          <div>
                            <label className="lbl">Units</label>
                            <select className="inp" value={activeItem.data.units} onChange={(e)=>updateActive("units", e.target.value)}>
                              <option value="WME">WME</option>
                              <option value="%">%</option>
                              <option value="RH">RH</option>
                              <option value="Temp">Temp</option>
                              <option value="Other">Other</option>
                            </select>
                          </div>
                        </div>

                        <div className="row" style={{marginTop:10}}>
                          <div>
                            <label className="lbl">Instrument</label>
                            <select className="inp" value={activeItem.data.instrument} onChange={(e)=>updateActive("instrument", e.target.value)}>
                              {INSTRUMENTS.map(x => <option key={x} value={x}>{x}</option>)}
                            </select>
                          </div>
                        </div>
                      </>
                    )}

                    <div className="row" style={{marginTop:10}}>
                      <div>
                        <label className="lbl">Approx. extent</label>
                        <input className="inp" placeholder='e.g., "2 ft x 3 ft area" / "localized"' value={activeItem.data.extent} onChange={(e)=>updateActive("extent", e.target.value)} />
                      </div>
                      <div>
                        <label className="lbl">Measurements</label>
                        <input className="inp" placeholder='e.g., "12 in x 18 in" / "4 ft linear"' value={activeItem.data.measurements} onChange={(e)=>updateActive("measurements", e.target.value)} />
                      </div>
                    </div>

                    <div style={{marginTop:10}}>
                      <label className="lbl">Tags</label>
                      <input className="inp" placeholder="e.g., blistered paint, north wall" value={activeItem.data.tags} onChange={(e)=>updateActive("tags", e.target.value)} />
                    </div>

                    <label className="lbl" style={{marginTop:10}}>Notes</label>
                    <textarea className="inp" value={activeItem.data.notes} onChange={(e)=>updateActive("notes", e.target.value)} />

                    <div className="hr"></div>
                    <div className="lbl">Photo</div>
                    <div className="tiny">Attach a representative photo and caption for this item.</div>
                    <div style={{marginTop:10, display:"flex", gap:10, flexWrap:"wrap"}}>
                      <label className="btn btnPrimary" style={{display:"inline-flex", cursor:"pointer"}}>
                        Upload Photo
                        <input type="file" accept="image/*" style={{display:"none"}}
                          onChange={(e)=> { const f = e.target.files?.[0]; if(f) setActivePhoto(f); e.target.value=""; }}
                        />
                      </label>
                      <button className="btn" disabled={!activeItem.data.photo} onClick={() => updateActive("photo", null)}>
                        Remove
                      </button>
                    </div>
                    <label className="lbl" style={{marginTop:10}}>Photo caption</label>
                    <input className="inp" placeholder="Caption for the photo" value={activeItem.data.photoCaption} onChange={(e)=>updateActive("photoCaption", e.target.value)} />
                    {activeItem.data.photo?.url && (
                      <div style={{marginTop:10}}>
                        <img src={activeItem.data.photo.url} alt="item" style={{width:"100%", borderRadius:14, border:"1px solid rgba(226,232,240,0.95)"}} />
                        <div className="tiny" style={{marginTop:6}}>Loaded: <b>{activeItem.data.photo.name}</b></div>
                      </div>
                    )}

                    <div className="hr"></div>
                    <div className="row">
                      <button className="btn btnDanger btnFull" onClick={deleteActive}>Delete item</button>
                    </div>
                  </>
                )}
              </div>

            </div>
          </div>
          </div>

          <div className="printArea">
            {pages.map((page, index) => {
              const pageItems = items.filter(it => it.pageId === page.id);
              const aoiItems = pageItems.filter(it => it.type === "aoi" || it.type === "area");
              const readItems = pageItems.filter(it => it.type === "read");
              const lineItems = pageItems.filter(it => it.type === "line");
              const noteItems = pageItems.filter(it => it.type === "note");
              return (
                <div key={page.id} className="printPage">
                  <div className="printHeader">
                    <div>
                      <div className="printTitle">{projectName || "Project"}  {page.name || `Page ${index + 1}`}</div>
                      <div className="printMeta">{eventContext}{inspectionDate ? `  ${inspectionDate}` : ""}</div>
                      <div className="printMeta">{propertyCity}</div>
                    </div>
                    <div className="printMeta">Page {index + 1} of {pages.length}</div>
                  </div>
                  <div className="printMeta" style={{marginBottom:12}}>
                    <div><b>Scope:</b> {scopeNote}</div>
                    {residentNotes && <div><b>Resident / client statement:</b> {residentNotes}</div>}
                  </div>

                  <div className="printSheetWrap">
                    <div className="printSheet">
                      {page.bg?.url ? <img className="sheetBg" src={page.bg.url} alt="background" /> : null}
                      <Grid />
                      <svg className="sheetOverlay" width="1024" height="720" viewBox="0 0 1024 720">
                        {pageItems.filter(it => it.type === "area" && Array.isArray(it.points)).map(it => (
                          <polygon
                            key={it.id}
                            className="areaPoly"
                            points={it.points.map(p => `${p.x*1024},${p.y*720}`).join(" ")}
                          />
                        ))}
                        {pageItems.filter(it => it.type === "line" && it.line).map(it => (
                          <line
                            key={it.id}
                            className={`lineStroke ${it.data.lineType === "drain" ? "drain" : ""}`}
                            x1={it.line.x1*1024}
                            y1={it.line.y1*720}
                            x2={it.line.x2*1024}
                            y2={it.line.y2*720}
                          />
                        ))}
                      </svg>
                      {pageItems.filter(it => it.type === "area" && Array.isArray(it.points)).map(it => {
                        const center = polygonCenter(it.points);
                        return (
                          <div
                            key={`${it.id}-print-label`}
                            className="areaLabel"
                            style={{ left: `${center.x*100}%`, top: `${center.y*100}%` }}
                          >
                            {it.name}
                          </div>
                        );
                      })}
                      {pageItems.filter(it => it.type === "line" && it.line).map(it => {
                        const mid = lineMidpoint(it.line);
                        return (
                          <div
                            key={`${it.id}-print-line-label`}
                            className={`lineLabel ${it.data.lineType === "drain" ? "drain" : ""}`}
                            style={{ left: `${mid.x*100}%`, top: `${mid.y*100}%` }}
                          >
                            {it.name}
                          </div>
                        );
                      })}
                      {pageItems.filter(it => it.type !== "area" && it.type !== "line").map(it => (
                        <div
                          key={it.id}
                          className={"marker " + markerColorClass(it.type)}
                          style={{ left: `${it.x*100}%`, top: `${it.y*100}%` }}
                          title={it.name}
                        >
                          {it.name.split("-")[0]}
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="printList">
                    <h4>Observations</h4>
                    {pageItems.length === 0 && <div className="printFoot">No items documented on this page.</div>}
                    {pageItems.length > 0 && (
                      <>
                        <h4>Areas of Interest</h4>
                        <div className="printGrid">
                          {aoiItems.map(it => (
                            <div key={`${it.id}-summary`} className="printListItem">
                              <div><b>{it.name}</b>  {typeLabels[it.type] || it.type}</div>
                              <div>Room/Elevation: {it.data.room}  {it.data.elevation}</div>
                              <div>Condition: {it.data.condition}</div>
                              {it.data.measurements && <div>Measurements: {it.data.measurements}</div>}
                              {it.data.extent && <div>Extent: {it.data.extent}</div>}
                              {it.data.tags && <div>Tags: {it.data.tags}</div>}
                              {it.data.notes && <div>Notes: {it.data.notes}</div>}
                              {it.data.photoCaption && <div>Photo caption: {it.data.photoCaption}</div>}
                              {it.data.photo?.url && (
                                <div style={{marginTop:8}}>
                                  <img src={it.data.photo.url} alt={it.name} style={{width:"160px", borderRadius:10, border:"1px solid rgba(148,163,184,0.45)"}} />
                                </div>
                              )}
                            </div>
                          ))}
                        </div>

                        <h4>Moisture Readings</h4>
                        <div className="printGrid">
                          {readItems.map(it => (
                            <div key={`${it.id}-summary`} className="printListItem">
                              <div><b>{it.name}</b>  {typeLabels[it.type] || it.type}</div>
                              <div>Room/Elevation: {it.data.room}  {it.data.elevation}</div>
                              {it.data.reading && <div>Reading: {it.data.reading} {it.data.units}</div>}
                              {it.data.instrument && <div>Instrument: {it.data.instrument}</div>}
                              {it.data.measurements && <div>Measurements: {it.data.measurements}</div>}
                              {it.data.extent && <div>Extent: {it.data.extent}</div>}
                              {it.data.tags && <div>Tags: {it.data.tags}</div>}
                              {it.data.notes && <div>Notes: {it.data.notes}</div>}
                              {it.data.photoCaption && <div>Photo caption: {it.data.photoCaption}</div>}
                              {it.data.photo?.url && (
                                <div style={{marginTop:8}}>
                                  <img src={it.data.photo.url} alt={it.name} style={{width:"160px", borderRadius:10, border:"1px solid rgba(148,163,184,0.45)"}} />
                                </div>
                              )}
                            </div>
                          ))}
                        </div>

                        <h4>Lines & Notes</h4>
                        <div className="printGrid">
                          {[...lineItems, ...noteItems].map(it => (
                            <div key={`${it.id}-summary`} className="printListItem">
                              <div><b>{it.name}</b>  {typeLabels[it.type] || it.type}</div>
                              <div>Room/Elevation: {it.data.room}  {it.data.elevation}</div>
                              {it.type === "line" && <div>Line type: {it.data.lineType === "drain" ? "Drain" : "Plumbing"}</div>}
                              {it.data.tags && <div>Tags: {it.data.tags}</div>}
                              {it.data.notes && <div>Notes: {it.data.notes}</div>}
                              {it.data.photoCaption && <div>Photo caption: {it.data.photoCaption}</div>}
                              {it.data.photo?.url && (
                                <div style={{marginTop:8}}>
                                  <img src={it.data.photo.url} alt={it.name} style={{width:"160px", borderRadius:10, border:"1px solid rgba(148,163,184,0.45)"}} />
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      </>
                    )}
                  </div>
                  <div className="printFoot">Generated with TitanMoisture v0.2</div>
                </div>
              );
            })}
          </div>
        </>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
